#!/bin/bash

gtx_1070_ti () {
	INDEX=$1
	if [ -z "$1" ]; then
		INDEX=0
	fi

	nvidia-smi -i ${INDEX} --persistence-mode=1

	nohup nvidia-settings -a [gpu:${INDEX}]/GPUPowerMizerMode=1 \
						  -a [gpu:${INDEX}]/GPUGraphicsClockOffset[3]=0 \
						  -a [gpu:${INDEX}]/GPUMemoryTransferRateOffset[3]=0 \
						  -a [gpu:${INDEX}]/GPUFanControlState=1 \
						  -a [fan:${INDEX}]/GPUTargetFanSpeed=100 \
						  -a [gpu:${INDEX}]/GPUGraphicsClockOffset[3]=150 \
						  -a [gpu:${INDEX}]/GPUMemoryTransferRateOffset[3]=500 \
						  --ctrl-display=:1 &

	nvidia-smi -i ${INDEX} --power-limit=130
}

gtx_1060_6gb () {
	INDEX=$1
	if [ -z "$1" ]; then
		INDEX=0
	fi

	nvidia-smi -i ${INDEX} --persistence-mode=1

	nohup nvidia-settings -a [gpu:${INDEX}]/GPUPowerMizerMode=1 \
						  -a [gpu:${INDEX}]/GPUGraphicsClockOffset[3]=0 \
						  -a [gpu:${INDEX}]/GPUMemoryTransferRateOffset[3]=0 \
						  -a [gpu:${INDEX}]/GPUFanControlState=1 \
						  -a [fan:${INDEX}]/GPUTargetFanSpeed=100 \
						  -a [gpu:${INDEX}]/GPUGraphicsClockOffset[3]=150 \
						  -a [gpu:${INDEX}]/GPUMemoryTransferRateOffset[3]=500 \
						  --ctrl-display=:1 &

	nvidia-smi -i ${INDEX} --power-limit=100
}

gtx_1070 () {
	INDEX=$1
	if [ -z "$1" ]; then
		INDEX=0
	fi

	nvidia-smi -i ${INDEX} --persistence-mode=1

	nohup nvidia-settings -a [gpu:${INDEX}]/GPUPowerMizerMode=1 \
						  -a [gpu:${INDEX}]/GPUGraphicsClockOffset[3]=0 \
						  -a [gpu:${INDEX}]/GPUMemoryTransferRateOffset[3]=0 \
						  -a [gpu:${INDEX}]/GPUFanControlState=1 \
						  -a [fan:${INDEX}]/GPUTargetFanSpeed=100 \
						  -a [gpu:${INDEX}]/GPUGraphicsClockOffset[3]=150 \
						  -a [gpu:${INDEX}]/GPUMemoryTransferRateOffset[3]=500 \
						  --ctrl-display=:1 &

	nvidia-smi -i ${INDEX} --power-limit=110
}

overclock () {
	read index;
	read model;

	if [ "$model" == "GeForce GTX 1070 Ti" ]; then
		gtx_1070_ti ${index};
	elif [ "$model" == "GeForce GTX 1060 6GB" ]; then
		gtx_1060_6gb ${index};
	elif [ "$model" == "GeForce GTX 1070" ]; then
		gtx_1070 ${index};
	else
		echo "Unknown model ${model}";
	fi
}

nvidia-smi --query-gpu=index,gpu_name --format=csv,noheader | while read line; do
	echo $line | awk -F', ' '{printf "%s\n%s", $1, $2}' | overclock
done
